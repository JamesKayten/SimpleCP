#!/bin/bash

# TCC Role Enforcement Pre-Commit Hook
# Prevents TCC from committing code files - enforces task assignment workflow

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Only run if .tcc-active marker exists (identifies TCC sessions)
if [[ ! -f ".tcc-active" ]]; then
    # Not a TCC session - allow all commits
    exit 0
fi

# Code file extensions that TCC should NOT be modifying
CODE_EXTENSIONS=(
    "swift" "py" "js" "ts" "tsx" "jsx"
    "java" "go" "rs" "cpp" "c" "h" "hpp"
    "vue" "rb" "php" "dart" "kt" "m" "mm"
    "sh" "bash" "zsh"
)

# Files TCC is ALLOWED to modify (project management)
ALLOWED_FILES=(
    "BOARD.md"
    "TASKS.md"
    "STATUS"
    "STATUS.md"
    "CURRENT_TASK.md"
    "communication.log"
    "*.log"
)

# Documentation files TCC can modify
ALLOWED_PATTERNS=(
    "README.md"
    "CHANGELOG.md"
    "CONTRIBUTING.md"
    "LICENSE"
    "*.txt"
    ".gitignore"
    ".ai-framework/communications/**"
    ".ai-framework/status/**"
)

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check each staged file
VIOLATIONS=()
while IFS= read -r file; do
    if [[ -z "$file" ]]; then
        continue
    fi

    # Check if it's an allowed file
    basename=$(basename "$file")
    allowed=false

    for pattern in "${ALLOWED_FILES[@]}"; do
        if [[ "$basename" == $pattern ]]; then
            allowed=true
            break
        fi
    done

    # Check allowed patterns
    if [[ "$allowed" == false ]]; then
        for pattern in "${ALLOWED_PATTERNS[@]}"; do
            if [[ "$file" == $pattern ]] || [[ "$file" =~ $pattern ]]; then
                allowed=true
                break
            fi
        done
    fi

    if [[ "$allowed" == true ]]; then
        continue
    fi

    # Check if it's a code file
    extension="${file##*.}"
    for code_ext in "${CODE_EXTENSIONS[@]}"; do
        if [[ "$extension" == "$code_ext" ]]; then
            VIOLATIONS+=("$file")
            break
        fi
    done
done <<< "$STAGED_FILES"

# If violations found, block commit and show guidance
if [[ ${#VIOLATIONS[@]} -gt 0 ]]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}ðŸš« COMMIT BLOCKED - TCC ROLE VIOLATION${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}TCC attempted to commit code files:${NC}"
    for file in "${VIOLATIONS[@]}"; do
        echo -e "  ${RED}âœ—${NC} $file"
    done
    echo ""
    echo -e "${YELLOW}ðŸ“‹ CORRECT WORKFLOW:${NC}"
    echo "1. TCC found issues during testing âœ…"
    echo "2. TCC should POST tasks to BOARD.md:"
    echo ""
    echo -e "${GREEN}## OCC Tasks - $(date +%Y-%m-%d)${NC}"
    echo -e "${GREEN}Issues found during testing. OCC please fix:${NC}"
    echo -e "${GREEN}- Issue 1: Description and error message${NC}"
    echo -e "${GREEN}- Issue 2: Description and error message${NC}"
    echo ""
    echo "3. OCC implements the fixes âœ…"
    echo "4. TCC tests and merges âœ…"
    echo ""
    echo -e "${YELLOW}ðŸ“– Role Division:${NC}"
    echo -e "  ${GREEN}OCC (Developer):${NC} Write code, implement features, fix bugs"
    echo -e "  ${GREEN}TCC (Project Manager):${NC} Test, validate, merge, assign tasks"
    echo ""
    echo -e "${YELLOW}See: rules/OCC_TCC_ROLES.md for complete role definitions${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    exit 1
fi

# No violations - allow commit
exit 0
