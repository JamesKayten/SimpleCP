#!/bin/bash
# MASTER AI COLLABORATION COMMAND
# Usage: ~/ai [command] [options]

FRAMEWORK_DIR="/Volumes/User_Smallfavor/Users/Smallfavor/Documents/AI-Collaboration-Management"

# Repository validation function - ensures Claude is in the proper repo
validate_repository() {
    # Check if we're in a git repository
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        echo "‚ùå Error: Not in a git repository"
        echo "üí° Navigate to your SimpleCP project directory first"
        return 1
    fi

    # Check if this is the SimpleCP repository by looking for key files
    if [ ! -f "docs/CLAUDE.md" ] || [ ! -f "Makefile" ]; then
        echo "‚ùå Error: Not in the SimpleCP repository"
        echo "üí° Navigate to your SimpleCP project directory"
        echo "   Expected files: docs/CLAUDE.md, Makefile"
        return 1
    fi

    return 0
}

case "$1" in
    "setup"|"init")
        # AI Collaboration Setup
        shift
        validate_repository && exec "$FRAMEWORK_DIR/setup-ai-collaboration.sh" "$@"
        ;;

    "restore"|"start")
        # Session Recovery - Start
        if [ -f "./restore_session.sh" ]; then
            validate_repository && exec ./restore_session.sh
        else
            echo "‚ùå No session recovery in this project"
            echo "üí° Run: ~/ai setup --preset python"
        fi
        ;;

    "snapshot"|"save"|"end")
        # Session Recovery - End
        if [ -f "./create_session_snapshot.sh" ]; then
            validate_repository && exec ./create_session_snapshot.sh
        else
            echo "‚ùå No session recovery in this project"
            echo "üí° Run: ~/ai setup --preset python"
        fi
        ;;

    "rules")
        # Rules Management
        shift
        validate_repository && exec "$FRAMEWORK_DIR/update-claude-rules.sh" "$@"
        ;;

    "status")
        # Show status of all systems
        echo "ü§ñ AI COLLABORATION STATUS"
        echo "=========================="
        echo

        # Check if current project has framework
        if [ -f "./restore_session.sh" ]; then
            echo "‚úÖ Current project: AI collaboration enabled"
        else
            echo "‚ùå Current project: No AI collaboration"
            echo "   Run: ~/ai setup --preset python"
        fi

        # Show rules count
        if [ -f "$FRAMEWORK_DIR/CLAUDE_BEHAVIOR_RULES.md" ]; then
            RULE_COUNT=$(grep -c "^-" "$FRAMEWORK_DIR/CLAUDE_BEHAVIOR_RULES.md")
            echo "‚úÖ Behavior rules: $RULE_COUNT active rules"
        else
            echo "‚ùå Behavior rules: Not found"
        fi

        echo
        echo "üõ†Ô∏è AVAILABLE COMMANDS:"
        echo "~/ai setup --preset python    # Add AI collaboration to project"
        echo "~/ai restore                   # Start session (instant recovery)"
        echo "~/ai save                      # End session (capture state)"
        echo "~/ai rules --show              # View behavior rules"
        echo "~/ai rules --add 'new rule'    # Add behavior rule"
        echo "~/ai status                    # Show this status"
        ;;

    *)
        # Auto-restore if in project with session recovery
        if [ -f "./restore_session.sh" ]; then
            validate_repository && exec ./restore_session.sh
        else
            echo "ü§ñ AI COLLABORATION MASTER COMMAND"
            echo "=================================="
            echo
            echo "USAGE:"
            echo "  ~/ai setup --preset python     # Add AI collaboration to project"
            echo "  ~/ai restore                    # Start session (instant recovery)"
            echo "  ~/ai save                       # End session (capture state)"
            echo "  ~/ai rules --show               # View behavior rules"
            echo "  ~/ai rules --add 'new rule'     # Add behavior rule"
            echo "  ~/ai status                     # Show system status"
            echo
            echo "EXAMPLES:"
            echo "  ~/ai setup --preset react --max-file-size 150"
            echo "  ~/ai rules --add 'Be concise, no long explanations'"
        fi
        ;;
esac